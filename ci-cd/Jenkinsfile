pipeline {
    agent any

    parameters {
        credentials(name: 'DOCKER_CREDENTIALS', description: 'Select Docker Hub credentials to use')
    }

    environment {
        DOCKER_IMAGE     = "akkicasm06/cloud-native-test-app"
        IMAGE_TAG        = "${env.BUILD_ID}"
        HELM_CHART_PATH  = "helm/app-chart"
        NAMESPACE        = "observability"
    }

    stages {
        stage('1. Code Checkout') {
            steps {
                echo "Code checkout done."
            }
        }

        stage('2. Build Image') {
            steps {
                dir('test-app') {
                    bat "docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} ."
                }
            }
        }

        stage('3. Push Image to Docker Hub') {
            steps {
                script {
                    // Credential ID comes from user/environment â€” not hardcoded
                    withCredentials([usernamePassword(
                        credentialsId: params.DOCKER_CREDENTIALS,
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        bat "docker login -u %DOCKER_USER% -p %DOCKER_PASS%"
                        bat "docker push ${DOCKER_IMAGE}:${IMAGE_TAG}"
                    }
                }
            }
        }

        stage('4. Helm Lint') {
            steps {
                dir('helm/app-chart') {
                    bat "helm lint ."
                }
            }
        }

        stage('5. Deploy Observability & App') {
            steps {
                withEnv(['KUBECONFIG=C:\\Users\\aksha\\.kube\\config']) {
                    bat "kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -"

                    bat "helm repo add grafana https://grafana.github.io/helm-charts --force-update"
                    bat "helm repo add prometheus-community https://prometheus-community.github.io/helm-charts --force-update"
                    bat "helm repo update"

                    bat "helm upgrade --install test-app-release ${HELM_CHART_PATH} --set image.repository=${DOCKER_IMAGE} --set image.tag=${IMAGE_TAG} -n ${NAMESPACE} --wait --timeout 5m"
                    bat "kubectl get pods -n ${NAMESPACE}"
                }
            }
        }
    }
}
