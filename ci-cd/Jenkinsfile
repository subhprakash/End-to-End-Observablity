// Docker Username set kar diya gaya hai: akkicasm06
// Final fix applied for Windows 'bat' command and UUID credentials
pipeline {
    agent any
    environment {
        DOCKER_IMAGE = "akkicasm06/cloud-native-test-app"
        IMAGE_TAG = "${env.BUILD_ID}"
        HELM_CHART_PATH = "helm/app-chart"
    }
    stages {
        stage('1. Code Checkout') { 
            steps { 
                echo "Code checkout done." 
            } 
        }

        stage('2. Build Image') {
            steps {
                dir('test-app') { 
                    bat "docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} ."
                }
            }
        }

        stage('3. Push Image to Docker Hub') {
            steps {
                // Credential ID fix: '5ead5699-f937-4fbe-9ceb-3dab4fab56024'
                withCredentials([usernamePassword(credentialsId: '5ead5699-f937-4fbe-9ceb-3dab4fab56024', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                    bat "docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD}"
                    echo "Image Docker Hub Push."
                    bat "docker push ${DOCKER_IMAGE}:${IMAGE_TAG}"
                }
            }
        }

        stage('3.5. Quality Assurance (Testing & Scanning)') {
            steps {
                echo "--- TO BE IMPLEMENTED: Application Testing (e.g., npm test) ---"
                echo "--- TO BE IMPLEMENTED: Docker Image Vulnerability Scan (e.g., Trivy) ---"
                echo "Quality assurance stage complete. Proceeding to deployment."
            }
        }

        stage('4. Helm Lint') {
            steps {
                echo "Helm chart ki syntax (lint) checking ho rahi hai."
                dir('helm/app-chart') {
                    bat "helm lint ."
                }
            }
        }

        stage('4.5. Kubeconfig Setup') {
            steps {
                echo "Kubeconfig path defined and environment variables are set for next stage."
            }
        }

        stage('5. Deploy Observability & App') {
            steps { // withEnv must be inside steps block
                // KUBECONFIG variable set for the Helm commands
                withEnv(['KUBECONFIG=C:\\Users\\aksha\\.kube\\config']) {
                    
                    // 1. GRAFANA (Visualization) ko alag deploy karein (10m timeout)
                    echo "--- 1. Deploying Grafana (Visualization) ---"
                    bat "helm repo add grafana https://grafana.github.io/helm-charts --force-update"
                    bat """
                    helm upgrade --install grafana grafana/grafana ^
                    --set persistence.enabled=false ^
                    --wait --timeout 10m 
                    """
                    
                    // 2. LOKI (Logging Store) aur Promtail ko alag deploy karein (10m timeout)
                    echo "--- 2. Deploying Loki (Logging Store) & Promtail ---"
                    bat "helm repo add loki https://grafana.github.io/helm-charts --force-update" 
                    bat """
                    helm upgrade --install loki loki/loki ^
                    --set persistence.enabled=false ^
                    --set promtail.enabled=true ^
                    --wait --timeout 10m
                    """
                    
                    echo "--- 3. Deploying Custom Test Application ---\n"
                    // 3. Custom App deploy karein (5m timeout)
                    bat """
                    helm upgrade --install test-app-release ${HELM_CHART_PATH} ^
                    --set image.repository=${DOCKER_IMAGE} ^
                    --set image.tag=${IMAGE_TAG} ^
                    --wait --timeout 5m
                    """
                }
            }
        }
    }
}