pipeline {
    agent any

    parameters {
        booleanParam(name: 'CLEANUP', defaultValue: false, description: 'Stop and remove containers after build')
    }

    environment {
        IMAGE_NAME   = "akkicasm06/cloud-native-test-app"
        COMPOSE_PATH = "compose"
    }

    stages {
        stage('1. Checkout') {
            steps {
                checkout scm
                echo "‚úÖ Code checked out from repository"
            }
        }

        stage('2. Build Application Image') {
            steps {
                dir('test-app') {
                    echo "üß© Building Docker image for the app..."
                    bat "docker build -t ${IMAGE_NAME}:latest ."
                }
            }
        }

        stage('3. Start Observability Stack') {
            steps {
                dir("${COMPOSE_PATH}") {
                    echo "üöÄ Launching Observability Stack via Docker Compose..."
                    // Stop any old stack cleanly
                    bat "docker compose down || echo 'No previous stack found'"
                    // Bring everything up
                    bat "docker compose up -d --build"
                }
            }
        }

        stage('4. Verify Running Containers') {
            steps {
                script {
                    echo "üîç Checking running containers..."
                    bat 'docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'
                }
            }
        }

        stage('5. Open Application & Dashboards') {
            steps {
                script {
                    echo "üåê Opening application and dashboards..."
                    bat """
                    start http://localhost:8085
                    start http://localhost:3000
                    start http://localhost:5601
                    """
                    echo """
                    ‚úÖ Application:  http://localhost:8085
                    üìä Grafana:      http://localhost:3000 (admin / admin)
                    üß© Kibana:       http://localhost:5601
                    """
                }
            }
        }

        stage('6. Optional Cleanup') {
            when {
                expression { return params.CLEANUP == true }
            }
            steps {
                dir("${COMPOSE_PATH}") {
                    echo "üßπ Cleaning up stack..."
                    bat "docker compose down -v"
                }
            }
        }
    }

    post {
        always {
            echo "üèÅ Pipeline finished successfully (or skipped cleanup)."
        }
    }
}
