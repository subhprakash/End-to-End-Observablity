pipeline {
    agent any

    environment {
        IMAGE_NAME = "akkicasm06/cloud-native-test-app"
        COMPOSE_PATH = "compose"
    }

    stages {
        stage('1. Checkout') {
            steps {
                checkout scm
                echo "‚úÖ Code checked out from repo"
            }
        }

        stage('2. Build App Image') {
            steps {
                dir('test-app') {
                    bat "docker build -t ${IMAGE_NAME}:latest ."
                }
                echo "üß© App Docker image built successfully"
            }
        }

        stage('3. Start Observability Stack') {
            steps {
                dir("${COMPOSE_PATH}") {
                    echo "üöÄ Launching stack via Docker Compose..."
                    bat "docker compose down || echo 'No previous stack found'"
                    bat "docker compose up -d --build"
                }
            }
        }

        stage('4. Verify Containers') {
            steps {
                script {
                    echo "üîç Checking running containers..."
                    bat 'docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'
                }
            }
        }

        stage('5. Optional Cleanup') {
            when {
                expression { return params.CLEANUP == true }
            }
            steps {
                dir("${COMPOSE_PATH}") {
                    echo "üßπ Cleaning up containers..."
                    bat "docker compose down -v"
                }
            }
        }
    }

    post {
        always {
            echo "üèÅ Pipeline finished."
        }
    }
}
