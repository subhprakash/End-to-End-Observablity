pipeline {
    agent any

    parameters {
        // I've kept CLEANUP but modified Stage 6 to always run after the wait.
        booleanParam(name: 'CLEANUP', defaultValue: false, description: 'Stop and remove containers after build')
    }

    environment {
        IMAGE_NAME   = "akkicasm06/cloud-native-test-app"
        COMPOSE_PATH = "compose"
    }

    stages {
        stage('1. Checkout') {
            steps {
                checkout scm
                echo "‚úÖ Code checked out from repository"
            }
        }

        stage('2. Build Application Image') {
            steps {
                dir('test-app') {
                    echo "üß© Building Docker image for the app..."
                    bat "docker build -t ${IMAGE_NAME}:latest ."
                }
            }
        }

        stage('3. Start Observability Stack') {
            steps {
                dir("${COMPOSE_PATH}") {
                    echo "üöÄ Launching Observability Stack via Docker Compose..."
                    // Stop any old stack cleanly
                    bat "docker compose down || echo 'No previous stack found'"
                    // Bring everything up
                    bat "docker compose up -d --build"
                }
            }
        }

        // üü¢ FIXED STAGE: Removed the interactive 'start' commands
        stage('4. Display Dashboards URLs') {
            steps {
                script {
                    echo "üîç Checking running containers and displaying dashboard URLs..."
                    // Use 'docker ps' for non-interactive verification
                    bat 'docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'
                    
                    // The interactive 'start' commands are now GONE.
                    
                    echo """
                    
                    ********************************************************************************
                    * ‚úÖ Stack is running. Use these URLs in your browser to view the dashboards:  *
                    ********************************************************************************
                    * App:      http://localhost:8085
                    * Grafana:  http://localhost:3000 (admin / admin)
                    * Kibana:   http://localhost:5601
                    ********************************************************************************
                    
                    """
                }
            }
        }
        
        // üåü NEW STAGE: Waits for 15 minutes before proceeding
        stage('5. Wait for Testing (15 mins)') {
            steps {
                script {
                    echo "‚è≥ Stack is running for 15 minutes. Interact with the application to generate data."
                    
                    timeout(time: 15, unit: 'MINUTES') {
                        sleep(900) // 900 seconds = 15 minutes
                    }
                    
                    echo "‚è± 15 minutes passed. Proceeding to cleanup."
                }
            }
        }

        // üåü MODIFIED STAGE: Renamed and modified to run automatically
        stage('6. Automatic Cleanup') {
            steps {
                dir("${COMPOSE_PATH}") {
                    echo "üßπ Automatically cleaning up stack..."
                    // The -v flag ensures volumes are removed, which is a thorough cleanup.
                    bat "docker compose down -v"
                }
            }
        }
    }

    post {
        always {
            echo "üèÅ Pipeline finished. All resources have been cleaned up."
        }
    }
}